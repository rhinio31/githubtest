# --- Append AWS_DEFAULT_PROFILE to Git Bash default prompt safely ---

# Save Git Bash's original PROMPT_COMMAND and PS1 once
if [ -z "$__ORIGINAL_PROMPT_COMMAND" ]; then
  __ORIGINAL_PROMPT_COMMAND="$PROMPT_COMMAND"
fi
if [ -z "$__ORIGINAL_PS1" ]; then
  # Run the original PROMPT_COMMAND once to initialize PS1
  if [ -n "$__ORIGINAL_PROMPT_COMMAND" ]; then
    eval "$__ORIGINAL_PROMPT_COMMAND"
  fi
  __ORIGINAL_PS1="$PS1"
fi

# Define a wrapper to rebuild the prompt dynamically
__aws_extend_prompt() {
  # Run Git Bash's normal prompt setup each time
  if [ -n "$__ORIGINAL_PROMPT_COMMAND" ]; then
    eval "$__ORIGINAL_PROMPT_COMMAND"
  fi

  # Start from the clean original PS1 (so it never grows)
  PS1="$__ORIGINAL_PS1"

  # Append the AWS profile only if set
  if [ -n "$AWS_DEFAULT_PROFILE" ]; then
    PS1="${PS1%%\\\$*} (${AWS_DEFAULT_PROFILE})\$ "
  fi
}

PROMPT_COMMAND="__aws_extend_prompt"
