# --- Extend Git Bash prompt with AWS_DEFAULT_PROFILE, preserving venv and git info ---

# Save the original PROMPT_COMMAND and PS1 only once
if [ -z "$__ORIGINAL_PROMPT_COMMAND" ]; then
  __ORIGINAL_PROMPT_COMMAND="$PROMPT_COMMAND"
fi
if [ -z "$__ORIGINAL_PS1" ]; then
  # Initialize PS1 with the default Git Bash prompt
  if [ -n "$__ORIGINAL_PROMPT_COMMAND" ]; then
    eval "$__ORIGINAL_PROMPT_COMMAND"
  fi
  __ORIGINAL_PS1="$PS1"
fi

__aws_extend_prompt() {
  # Let Git Bash rebuild its normal PS1 each time
  if [ -n "$__ORIGINAL_PROMPT_COMMAND" ]; then
    eval "$__ORIGINAL_PROMPT_COMMAND"
  fi

  # Start from the default PS1 built by Git Bash (includes venv if active)
  local base_prompt="$PS1"

  # If AWS_DEFAULT_PROFILE is set, append it before the $
  if [ -n "$AWS_DEFAULT_PROFILE" ]; then
    PS1="${base_prompt%%\\\$*} (${AWS_DEFAULT_PROFILE})\$ "
  else
    PS1="$base_prompt"
  fi
}

PROMPT_COMMAND="__aws_extend_prompt"
